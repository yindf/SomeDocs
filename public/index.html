<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•èµ„æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>æŠ•èµ„æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
      <nav>
        <ul>
          <li><a href="#welcome" class="nav-link" data-section="welcome">é¦–é¡µ</a></li>
          <li><a href="#" id="loginNav" onclick="showLoginModal()">ç™»å½•</a></li>
          <li><a href="#" id="registerNav" onclick="showRegisterModal()">æ³¨å†Œ</a></li>
          <li><a href="#data" class="nav-link" data-section="data" id="dataNav" style="display: none;">æ•°æ®æŸ¥è¯¢</a></li>
          <li><a href="admin.html" id="adminLink" style="display: none;" target="_blank">ğŸ› ï¸ ç®¡ç†å‘˜æ§åˆ¶å°</a></li>
          <li><a href="#" id="logoutLink" style="display: none;" onclick="logout()">é€€å‡ºç™»å½•</a></li>
        </ul>
      </nav>
      
      <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ - ç§»åŠ¨åˆ°å¤´éƒ¨å³ä¸Šè§’ -->
      <div id="user-info" class="user-info-topright" style="display: none;">
        <div class="user-info-content">
          <div class="user-welcome">
            <span>æ¬¢è¿ï¼Œ<span id="username"></span></span>
            <span id="role-badge" class="role-badge"></span>
            <span id="industry-badge" class="industry-badge"></span>
            <a href="#" onclick="showProfileModal()" class="profile-link">ä¸ªäººä¸­å¿ƒ</a>
          </div>
          <div id="expire-warning" class="expire-warning" style="display: none;"></div>
        </div>
      </div>
    </header>

    <main>
      <!-- æ¬¢è¿é¡µé¢ -->
      <section id="welcome" class="panel active">
        <h2>æ¬¢è¿ä½¿ç”¨æŠ•èµ„æ•°æ®ç®¡ç†ç³»ç»Ÿ</h2>
        <div class="welcome-content">
          <div class="welcome-actions">
            <p>è¯·é€‰æ‹©æ“ä½œï¼š</p>
            <button class="btn btn-primary" onclick="showLoginModal()">ç™»å½•</button>
            <button class="btn" onclick="showRegisterModal()">æ³¨å†Œ</button>
          </div>
        </div>
      </section>

      <!-- æ•°æ®æŸ¥è¯¢é¡µé¢ -->
      <section id="data" class="panel">
        <div class="data-header">
          <h2>æŠ•èµ„æ•°æ®æŸ¥è¯¢</h2>
        </div>
        
        <div class="search-section">
          <div class="search-bar">
            <input type="text" id="searchInput" placeholder="æœç´¢å…¬å¸åç§°ã€è¡Œä¸šã€æŠ•èµ„æœºæ„...">
            <button id="searchButton" class="btn btn-search">ğŸ” æœç´¢</button>
            <button id="clearSearchButton" class="btn btn-secondary" onclick="clearSearch()" style="display: none;">æ¸…ç©º</button>
          </div>
        </div>
        
        <div class="data-stats" id="dataStats">
          <span>å…±æ‰¾åˆ° <strong id="totalCount">0</strong> æ¡è®°å½•</span>
        </div>
        
        <div class="table-container">
          <table id="dataTable" class="data-table">
            <thead>
              <tr>
                <th>å…¬å¸åç§°</th>
                <th>å…¬å¸ç®€ä»‹</th>
                <th>èèµ„è½®æ¬¡</th>
                <th>æ—¥æœŸ</th>
                <th>è¡Œä¸šèµ›é“</th>
                <th>æŠ•èµ„æœºæ„</th>
                <th id="actionColumn" style="display: none;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <tr>
                <td colspan="6" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination">
          <button id="prevPage" class="btn">ä¸Šä¸€é¡µ</button>
          <span id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
          <button id="nextPage" class="btn">ä¸‹ä¸€é¡µ</button>
        </div>
      </section>

      <!-- æœªç™»å½•æç¤º -->
      <section id="loginRequired" class="panel" style="display: none;">
        <div class="login-required">
          <h2>ğŸ”’ éœ€è¦ç™»å½•</h2>
          <p>è¯·å…ˆç™»å½•åå†è®¿é—®æŠ•èµ„æ•°æ®ã€‚</p>
          <div class="login-required-actions">
            <button class="btn btn-primary" onclick="showLoginModal()">å»ç™»å½•</button>
            <button class="btn" onclick="showRegisterModal()">æ³¨å†Œè´¦å·</button>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; 2024 æŠ•èµ„æ•°æ®ç®¡ç†ç³»ç»Ÿ</p>
    </footer>
  </div>

  <!-- ç™»å½•å¯¹è¯æ¡† -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç”¨æˆ·ç™»å½•</h3>
        <span class="close" onclick="closeModal('loginModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label for="loginUsername">ç”¨æˆ·å</label>
            <input type="text" id="loginUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
          </div>
          <div class="form-group">
            <label for="loginPassword">å¯†ç </label>
            <input type="password" id="loginPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">ç™»å½•</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('loginModal')">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- æ³¨å†Œå¯¹è¯æ¡† -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç”¨æˆ·æ³¨å†Œ</h3>
        <span class="close" onclick="closeModal('registerModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="registerForm">
          <div class="form-group">
            <label for="registerUsername">ç”¨æˆ·å</label>
            <input type="text" id="registerUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰">
          </div>
          <div class="form-group">
            <label for="registerPassword">å¯†ç </label>
            <input type="password" id="registerPassword" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
          </div>
          <div class="form-group">
            <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
            <input type="password" id="confirmPassword" required placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
          </div>
          <div class="form-group">
            <label for="registerEmail">é‚®ç®±</label>
            <input type="email" id="registerEmail" required placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
          </div>
          <div class="form-group">
            <label for="inviteCode">æ¿€æ´»ç </label>
            <input type="text" id="inviteCode" required placeholder="è¯·è¾“å…¥æ¿€æ´»ç ">
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('registerModal')">å–æ¶ˆ</button>
          </div>
        </form>
        <div class="modal-tips">
          <p><small>ğŸ’¬ å¦‚æœæ²¡æœ‰æ¿€æ´»ç ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š<strong>xintidee</strong></small></p>
        </div>
      </div>
    </div>
  </div>

    <!-- ä¸ªäººä¸­å¿ƒå¯¹è¯æ¡† -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ä¸ªäººä¸­å¿ƒ - ä¿®æ”¹å¯†ç </h3>
        <span class="close" onclick="closeModal('profileModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="change-password-form">
          <div class="form-group">
            <label for="current-password">å½“å‰å¯†ç </label>
            <input type="password" id="current-password" required>
          </div>
          
          <div class="form-group">
            <label for="new-password">æ–°å¯†ç </label>
            <input type="password" id="new-password" required>
          </div>
          
          <div class="form-group">
            <label for="confirm-password">ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirm-password" required>
          </div>
          
          <div id="profile-alert-container" class="alert hidden"></div>
          
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // æ˜¾ç¤ºä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†
    function showProfileModal() {
      document.getElementById('profileModal').style.display = 'block';
      document.getElementById('change-password-form').reset();
      hideProfileAlert();
    }
    
    // éšè—ä¸ªäººä¸­å¿ƒæç¤ºä¿¡æ¯
    function hideProfileAlert() {
      const alertContainer = document.getElementById('profile-alert-container');
      alertContainer.classList.add('hidden');
    }
    
    // æ˜¾ç¤ºä¸ªäººä¸­å¿ƒæç¤ºä¿¡æ¯
    function showProfileAlert(message, type) {
      const alertContainer = document.getElementById('profile-alert-container');
      alertContainer.className = `alert alert-${type}`;
      alertContainer.textContent = message;
      alertContainer.classList.remove('hidden');
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        alertContainer.classList.add('hidden');
      }, 3000);
    }
    
    // ä¿®æ”¹å¯†ç åŠŸèƒ½
    document.getElementById('change-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // å‰ç«¯éªŒè¯
      if (newPassword.length < 6) {
        showProfileAlert('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showProfileAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          showProfileAlert('è¯·é‡æ–°ç™»å½•', 'error');
          return;
        }
        
        const response = await fetch('/api/users/change-password', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            currentPassword,
            newPassword
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showProfileAlert('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
          // æ¸…ç©ºè¡¨å•
          document.getElementById('change-password-form').reset();
        } else {
          showProfileAlert(data.error || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
        showProfileAlert('ç½‘ç»œé”™è¯¯ï¼Œå¯†ç ä¿®æ”¹å¤±è´¥', 'error');
      }
    });
  </script>
</body>
</html>